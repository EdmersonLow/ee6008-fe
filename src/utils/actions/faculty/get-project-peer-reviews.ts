/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts
'use server';

import { cookies } from 'next/headers';

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

/* eslint-disable prettier/prettier */
// utils/actions/faculty/get-project-peer-reviews.ts

// utils/actions/faculty/get-project-peer-reviews.ts

export interface PeerReviewData {
	project: {
		id: number;
		title: string;
	};
	team_summary: {
		average_team_score: number;
		total_reviews: number;
		completion_percentage: number;
	};
	team_members: Array<{
		id: number;
		name: string;
		email: string;
		matriculation_number: string;
		scores: {
			average: number;
			received: number[];
			given: number[];
		};
	}>;
	review_pairs: Array<{
		reviewer: {
			id: number;
			name: string;
		};
		reviewee: {
			id: number;
			name: string;
		};
		review: {
			id: number;
			score: number;
			comments: string;
			submitted_at: string;
		};
	}>;
	score_matrix: {
		headers: string[];
		rows: Array<{
			name: string;
			scores: (number | null)[];
		}>;
	};
}

/**
 * Helper function to get access token from cookies
 */
export async function getAccessToken(): Promise<string | null> {
	const cookieStore = cookies();
	return cookieStore.get('session-token')?.value || null;
}

/**
 * Server-side function to get peer reviews for a project
 */
export async function getProjectPeerReviews(projectId: number): Promise<PeerReviewData | null> {
	if (!projectId) {
		console.error('No project ID provided for peer reviews query');
		return null;
	}

	// Get token from localStorage/sessionStorage or cookie
	const accessToken = await getAccessToken();

	if (!accessToken) {
		console.warn('No access token found for API request');
	}

	// Get API URL from environment
	const apiUrl = process.env.BACKEND_API_URL || '';
	if (!apiUrl) {
		console.error('No API URL found in environment variables');
		return null;
	}

	// Ensure apiUrl doesn't end with a slash
	const baseUrl = apiUrl.endsWith('/') ? apiUrl.slice(0, -1) : apiUrl;

	// Construct the URL with the provided project ID
	const url = `${baseUrl}/api/faculty/projects/${projectId}/peer-reviews`;

	console.log(`Fetching peer reviews from: ${url}`);

	try {
		const response = await fetch(url, {
			method: 'GET',
			headers: {
				'Content-Type': 'application/json',
				Authorization: accessToken ? `Bearer ${accessToken}` : '',
			},
			cache: 'no-store',
		});

		if (!response.ok) {
			throw new Error(`API error: ${response.status} ${response.statusText}`);
		}

		const data = await response.json();
		console.log('Peer reviews response received');

		return data;
	} catch (error) {
		console.error('Error fetching peer reviews:', error);
		return null;
	}
}
/**
 * Client-side function to get peer reviews for a project
 */
export async function getProjectPeerReviewsClient(
	projectId: number
): Promise<PeerReviewData | null> {
	if (!projectId) {
		console.error('No project ID provided for peer reviews query');
		return null;
	}

	// Get token from cookie (handled by getAccessToken)
	const accessToken = await getAccessToken();

	if (!accessToken) {
		console.warn('No access token found for API request');
	}

	// Get API URL from environment
	const apiUrl = process.env.BACKEND_API_URL || '';
	if (!apiUrl) {
		console.error('No API URL found in environment variables');
		return null;
	}

	// Ensure apiUrl doesn't end with a slash
	const baseUrl = apiUrl.endsWith('/') ? apiUrl.slice(0, -1) : apiUrl;

	// Construct the URL with the provided project ID
	const url = `${baseUrl}/api/faculty/projects/${projectId}/peer-reviews`;

	console.log(`Fetching peer reviews from: ${url}`);

	try {
		const response = await fetch(url, {
			method: 'GET',
			headers: {
				'Content-Type': 'application/json',
				Authorization: accessToken ? `Bearer ${accessToken}` : '',
			},
			next: { tags: ['peer-reviews', `project-${projectId}`] },
		});

		if (!response.ok) {
			throw new Error(`API error: ${response.status} ${response.statusText}`);
		}

		const data = await response.json();
		console.log('Peer reviews response received');

		return data;
	} catch (error) {
		console.error('Error fetching peer reviews:', error);
		return null;
	}
}
